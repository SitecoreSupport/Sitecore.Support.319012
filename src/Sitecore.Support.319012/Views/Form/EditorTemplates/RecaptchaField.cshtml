@*Sitecore.Support.319012*@
@using System.Text
@using Sitecore.Form.Core.Data
@using Sitecore.Forms.Mvc.Html
@using Sitecore.Forms.Mvc.ViewModels.Fields
@model Sitecore.Forms.Mvc.ViewModels.Fields.RecaptchaField

@{
    RecaptchaField recaptchaField = Model;
    ProtectionSchema robotDetection = recaptchaField.RobotDetection;
    StringBuilder stringBuilder = new StringBuilder();
    stringBuilder.Append(Html.OpenFormField(recaptchaField, robotDetection == null || !robotDetection.Enabled));
    stringBuilder.Append(Html.Hidden("Value"));

    if (recaptchaField.Visible)
    {
        TagBuilder tagBuilder = new TagBuilder("div");
        tagBuilder.AddCssClass("g-recaptcha");
        tagBuilder.MergeAttribute("data-theme", recaptchaField.Theme);
        tagBuilder.MergeAttribute("data-type", recaptchaField.CaptchaType);
        TagBuilder tagBuilder2 = new TagBuilder("script");
        tagBuilder2.MergeAttribute("src", "https://www.google.com/recaptcha/api.js?onload=onloadCallback&render=explicit");
        stringBuilder.Append(tagBuilder);
        stringBuilder.Append(tagBuilder2);
    }

    stringBuilder.Append(Html.CloseFormField(recaptchaField, true));
}

<script>
    var onloadCallback = function() {
        if (typeof ($scw) === "undefined") {
            window.$scw = jQuery.noConflict(true);
        }
        $scw('.g-recaptcha').each(function (index, el) {
            if (el.innerHTML=="") {
                grecaptcha.render(el, { 'sitekey': '@recaptchaField.SiteKey', 'callback': 'supportCallback' });
            }
        });
    };

    var supportCallback = function() {
        if (typeof ($scw) === "undefined") {
            window.$scw = jQuery.noConflict(true);
        }
        $scw(".validation-summary-errors").hide();
        $scw(".field-validation-error.help-block").hide();
        $scw(".control-label").css("color", "black");
    };
</script>
@Html.Raw(stringBuilder.ToString())
